# Bolt Marketplace

A fully responsive, real-time marketing platform built with Next.js 14, Supabase, and M-Pesa integration. Features secure escrow transactions, live chat, PWA support, and dark mode.

## Features

### Core Functionality
- **Real-Time Updates**: Instant notifications for listings, payments, escrow status, and messages using Supabase Realtime
- **Secure Escrow**: Funds held safely until transaction completion with buyer and seller protection
- **M-Pesa Integration**: Live payment processing with automatic callbacks and verification
- **Live Chat**: Real-time messaging between buyers and sellers
- **Three Dashboard Types**: Buyer, Seller, and Admin interfaces with role-based access

### User Experience
- **Fully Responsive**: Mobile-first design that works on all devices
- **Dark Mode**: System-aware theme with manual toggle (light/dark/system)
- **PWA Support**: Installable app with offline caching for static assets
- **Authentication**: Secure email/password authentication via Supabase Auth

### Security
- **Row-Level Security (RLS)**: All database tables protected with Postgres RLS policies
- **Encrypted Connections**: HTTPS and WSS for all data transmission
- **Admin Moderation**: Content flagging and dispute resolution tools

## Tech Stack

- **Frontend**: Next.js 14, React 18, TypeScript
- **Styling**: Tailwind CSS, shadcn/ui components
- **Backend**: Supabase (PostgreSQL, Auth, Realtime, Storage)
- **Payments**: M-Pesa Daraja API
- **PWA**: next-pwa for service worker and caching
- **Hosting**: Vercel (frontend) + Supabase (backend)

## Getting Started

### Prerequisites
- Node.js 18+ and npm
- Supabase account (database already provisioned)
- M-Pesa Daraja API credentials (for production payments)

### Installation

1. **Clone and install dependencies**:
```bash
npm install
```

2. **Environment variables** are already configured in `.env`:
```
NEXT_PUBLIC_SUPABASE_URL=https://rngjsmzxvigoxigcvytn.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

3. **Database is ready**: All tables, RLS policies, and seed data have been created

### Run Development Server

```bash
npm run dev
```

Open [http://localhost:3000](http://localhost:3000)

### Build for Production

```bash
npm run build
npm run start
```

## Database Schema

The platform uses the following key tables:

- **profiles**: Extended user data (linked to auth.users)
- **categories**: Product/service categories
- **listings**: Marketplace listings with pricing and escrow support
- **listing_images**: Image storage paths
- **subscription_plans**: Seller tier plans (FREE, EXTRA5, UNLIMITED)
- **seller_subscriptions**: Active subscriptions per seller
- **payments**: M-Pesa payment records
- **mpesa_callbacks**: Webhook audit trail
- **escrow_transactions**: Secure buyer-seller transactions
- **messages**: Real-time chat messages
- **flags**: Content moderation reports
- **audit_logs**: System activity tracking

All tables have RLS enabled for security.

## User Roles

### Buyer
- Browse and search active listings
- Filter by category
- View listing details
- Initiate escrow transactions
- Real-time chat with sellers

### Seller
- Create and manage listings
- Track views and engagement
- Subscription management (5 free, paid upgrades)
- View escrow transaction status
- Respond to buyer messages

### Admin
- Platform overview dashboard
- Content moderation (resolve flags)
- Escrow dispute resolution
- Payment monitoring
- User activity tracking

## Real-Time Features

All updates happen instantly via Supabase Realtime:

1. **Listings**: New listings appear immediately on buyer dashboard
2. **Escrow Status**: Both parties see status changes live
3. **Payments**: M-Pesa callback triggers instant UI updates
4. **Messages**: Live chat with typing indicators
5. **Admin Actions**: Moderation actions reflect immediately

## M-Pesa Integration

### Endpoint
`/api/payments/mpesa`

### Workflow
1. User initiates payment
2. STK Push sent to phone
3. User enters M-Pesa PIN
4. Callback received and verified
5. Payment status updated in real-time
6. Escrow or subscription activated automatically

### Configuration
Add to `.env` for production:
```
MPESA_CONSUMER_KEY=your_key
MPESA_CONSUMER_SECRET=your_secret
MPESA_PASSKEY=your_passkey
MPESA_SHORTCODE=your_shortcode
```

## PWA Features

The app is installable on all devices:

- **Manifest**: `/public/manifest.json`
- **Service Worker**: Auto-generated by next-pwa
- **Offline Support**: Cached static assets and recent listings
- **Icons**: PWA icons in `/public/icons/`

To install:
1. Open the app in a browser
2. Click "Install" or "Add to Home Screen"
3. Launch from your device's home screen

## Dark Mode

Theme toggle available in navbar:
- **Light**: Force light theme
- **Dark**: Force dark theme
- **System**: Follows device preference

Theme preference is:
- Saved to localStorage
- Synced to user profile in database
- Applied with smooth transitions

## Deployment

### Vercel (Frontend)
```bash
vercel --prod
```

### Supabase (Backend)
Already deployed and configured.

### Environment Variables
Ensure these are set in Vercel:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY` (for API routes)
- M-Pesa credentials (production only)

## Security Best Practices

1. **Never commit secrets**: Use environment variables
2. **RLS is mandatory**: All tables have policies enforced
3. **Validate user input**: Both client and server-side
4. **Use service role carefully**: Only in secure API routes
5. **Monitor admin actions**: Audit logs track all changes

## Subscription Tiers

| Plan | Price | Listings | Billing |
|------|-------|----------|---------|
| Free | KES 0 | 5 | Forever |
| Extra 5 | KES 20 | 10 | One-time |
| Unlimited | KES 50 | âˆž | Monthly |

Payment via M-Pesa with instant activation.

## Support

For issues or questions:
1. Check database RLS policies
2. Verify Supabase connection
3. Test M-Pesa in sandbox mode first
4. Review browser console for errors

## License

This project is proprietary and confidential.

---

Built with Next.js 14, Supabase, and M-Pesa
